# ============================================================================
#  N8N QUEUE MODE - PRODUCTION DEPLOYMENT FOR COOLIFY
# ============================================================================
#
#  Architecture:
#    - Main Instance: UI, webhooks, schedules, API
#    - Worker: Executes workflows (15 concurrent jobs)
#    - PostgreSQL: Workflow data and execution history
#    - Redis: Queue for job distribution
#    - Task Runners: Internal JavaScript execution (v2.0+ default)
#
#  Optimized for: 8GB VPS (uses 4-6GB for n8n services)
#
#  Key Features:
#    ✅ Queue mode with horizontal scaling
#    ✅ 15 concurrent worker jobs
#    ✅ Internal task runners (automatic code isolation)
#    ✅ 1GB Redis queue
#    ✅ 14-day execution pruning
#    ✅ Full metrics for AI cost tracking
#    ✅ Production security hardening
#
# ============================================================================

services:
  # ==========================================================================
  #                           MAIN N8N INSTANCE
  # ==========================================================================
  #
  # This is the primary n8n container that handles:
  #   - Web UI (https://n8n.your-domain.com)
  #   - Webhooks and forms
  #   - Scheduled workflows (cron triggers)
  #   - Manual workflow execution (offloaded to workers)
  #   - Queue management and coordination
  #
  # ==========================================================================
  
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    
    # Port Configuration
    # -----------------
    # Expose port 5678 for Coolify's reverse proxy (Traefik)
    ports:
      - 5678:5678
    
    environment:
      # ======================================================================
      # COOLIFY AUTO-PROVIDED VARIABLES
      # ======================================================================
      # These are automatically injected by Coolify - DO NOT modify
      - SERVICE_URL_N8N_5678              # Full URL with port
      - N8N_EDITOR_BASE_URL=$SERVICE_URL_N8N  # Base URL for n8n UI
      - WEBHOOK_URL=$SERVICE_URL_N8N      # URL for webhook endpoints
      - N8N_HOST=$SERVICE_URL_N8N         # Host configuration
      
      # ======================================================================
      # BASIC CONFIGURATION
      # ======================================================================
      - N8N_PATH=/                        # Root path for n8n
      - N8N_LISTEN_ADDRESS=0.0.0.0        # Listen on all interfaces
      - N8N_PORT=5678                     # Internal port
      
      # ======================================================================
      # TIMEZONE SETTINGS
      # ======================================================================
      # Important for: Cron schedules, execution timestamps, logs
      # Change to your timezone: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
      - GENERIC_TIMEZONE=Asia/Singapore
      - TZ=Asia/Singapore
      
      # ======================================================================
      # DATABASE CONNECTION (PostgreSQL)
      # ======================================================================
      # Stores: Workflows, credentials, execution history, settings
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_HOST=postgresql     # Points to service name below
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_USER=$SERVICE_USER_POSTGRES      # Coolify-provided
      - DB_POSTGRESDB_SCHEMA=public
      - DB_POSTGRESDB_PASSWORD=$SERVICE_PASSWORD_POSTGRES  # Coolify-provided
      
      # ======================================================================
      # QUEUE MODE CONFIGURATION (Redis)
      # ======================================================================
      # Enables horizontal scaling by distributing work to workers
      - EXECUTIONS_MODE=queue             # Enable queue mode (vs "regular")
      - QUEUE_BULL_REDIS_HOST=redis       # Points to redis service below
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_PASSWORD=REPLACE_WITH_YOUR_REDIS_PASSWORD  # ⚠️ CHANGE THIS
      - QUEUE_BULL_REDIS_DB=0             # Redis database number (0-15)
      - QUEUE_HEALTH_CHECK_ACTIVE=true    # Enable queue health monitoring
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true  # Route manual runs to workers
      
      # ======================================================================
      # SECURITY SETTINGS
      # ======================================================================
      - N8N_ENCRYPTION_KEY=$SERVICE_PASSWORD_ENCRYPTION  # Coolify-provided
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true  # Prevent Code nodes from reading env vars
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true  # Security: Disable bare git repos
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true  # Enforce file permissions
      - N8N_PROXY_HOPS=1                  # Number of proxy hops (for Coolify/Traefik)
      
      # ======================================================================
      # TASK RUNNERS (Code Execution Isolation)
      # ======================================================================
      # In n8n v2.0+, task runners are enabled by default in "internal" mode
      # This isolates Code nodes and AI calls in separate subprocesses
      # External mode requires separate containers (not needed for most setups)
      - N8N_RUNNERS_ENABLED=true
      
      # ======================================================================
      # METRICS & MONITORING
      # ======================================================================
      # Exposes Prometheus metrics at /metrics endpoint
      # Use for: AI cost tracking, performance monitoring, alerting
      - N8N_METRICS=true
      - N8N_METRICS_INCLUDE_DEFAULT_METRICS=true  # CPU, memory, etc.
      - N8N_METRICS_INCLUDE_QUEUE_METRICS=true    # Queue depth, job rate
      - N8N_METRICS_INCLUDE_WORKFLOW_ID_LABEL=true  # Track per-workflow
      - N8N_METRICS_INCLUDE_NODE_TYPE_LABEL=true    # Track per-node type
      
      # ======================================================================
      # N8N v2.0+ REQUIRED SETTINGS
      # ======================================================================
      # Binary data mode: Store files on filesystem (vs database)
      # Recommended for: Image processing, file uploads, large payloads
      - N8N_BINARY_DATA_MODE=filesystem
      
      # Execution History Pruning
      # Auto-delete old execution data to prevent database bloat
      - EXECUTIONS_DATA_PRUNE=true        # Enable auto-cleanup
      - EXECUTIONS_DATA_MAX_AGE=336       # Keep 14 days (336 hours)
      
      # ======================================================================
      # PERFORMANCE TUNING (8GB VPS)
      # ======================================================================
      - N8N_PAYLOAD_SIZE_MAX=64           # Max payload size in MB
      - EXECUTIONS_TIMEOUT=7200           # Workflow timeout: 2 hours (7200 seconds)
      
    # ========================================================================
    # VOLUME MOUNTS
    # ========================================================================
    volumes:
      # Persistent data: workflows, credentials, settings, binary files
      - n8n-data:/home/node/.n8n
      
      # Local files directory: For file operations, templates, exports
      # Maps to: /data/coolify/services/[service-id]/local-files on host
      - ./local-files:/files
      
    # ========================================================================
    # SERVICE DEPENDENCIES
    # ========================================================================
    # Start n8n only after these services are running
    # Note: No healthchecks used (they caused issues in testing)
    depends_on:
      - postgresql
      - redis
    
    # ========================================================================
    # RESTART POLICY
    # ========================================================================
    # Always restart unless manually stopped
    restart: unless-stopped
    
    # ========================================================================
    # SECURITY HARDENING
    # ========================================================================
    # Prevent privilege escalation attacks
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  #                           N8N WORKER
  # ==========================================================================
  #
  # Worker instance that executes workflows from the queue
  #
  # Concurrency: 15
  #   - Runs up to 15 workflows simultaneously
  #   - Adjust based on server resources (CPU cores × 2-3)
  #   - For 4-core server: 8-15 is optimal
  #   - For 8-core server: 15-24 is optimal
  #
  # This worker handles:
  #   - All queued workflow executions
  #   - Manual workflow runs (when OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true)
  #   - Background jobs and scheduled workflows
  #
  # ==========================================================================
  
  n8n-worker:
    image: docker.n8n.io/n8nio/n8n:latest
    
    # Worker Command
    # --------------
    # Start n8n in worker mode with concurrency setting
    command: worker --concurrency=15
    
    environment:
      # ======================================================================
      # TIMEZONE (Same as main instance)
      # ======================================================================
      - GENERIC_TIMEZONE=Asia/Singapore
      - TZ=Asia/Singapore
      
      # ======================================================================
      # DATABASE CONNECTION (Same as main instance)
      # ======================================================================
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_HOST=postgresql
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_USER=$SERVICE_USER_POSTGRES
      - DB_POSTGRESDB_SCHEMA=public
      - DB_POSTGRESDB_PASSWORD=$SERVICE_PASSWORD_POSTGRES
      
      # ======================================================================
      # QUEUE MODE (Same as main instance)
      # ======================================================================
      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_PASSWORD=REPLACE_WITH_YOUR_REDIS_PASSWORD  # ⚠️ CHANGE THIS
      - QUEUE_BULL_REDIS_DB=0
      - QUEUE_HEALTH_CHECK_ACTIVE=true
      
      # ======================================================================
      # SECURITY (Same as main instance)
      # ======================================================================
      - N8N_ENCRYPTION_KEY=$SERVICE_PASSWORD_ENCRYPTION
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_PROXY_HOPS=1
      
      # ======================================================================
      # TASK RUNNERS (Same as main instance)
      # ======================================================================
      - N8N_RUNNERS_ENABLED=true
      
      # ======================================================================
      # N8N v2.0+ REQUIRED (Same as main instance)
      # ======================================================================
      - N8N_BINARY_DATA_MODE=filesystem
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336
      
    # ========================================================================
    # VOLUME MOUNTS (Same as main instance)
    # ========================================================================
    volumes:
      - n8n-data:/home/node/.n8n
      - ./local-files:/files
      
    # ========================================================================
    # SERVICE DEPENDENCIES
    # ========================================================================
    depends_on:
      - postgresql
      - redis
    
    restart: unless-stopped
    
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  #                           POSTGRESQL 16
  # ==========================================================================
  #
  # Database for n8n:
  #   - Workflow definitions
  #   - Credentials (encrypted)
  #   - Execution history
  #   - Settings and configurations
  #
  # Version: PostgreSQL 16 (Alpine - minimal image)
  # Storage: Persistent volume (survives container restarts)
  #
  # ==========================================================================
  
  postgresql:
    image: postgres:16-alpine
    
    # ========================================================================
    # VOLUME MOUNTS
    # ========================================================================
    volumes:
      # Persistent database storage
      - postgresql-data:/var/lib/postgresql/data
      
    environment:
      # Database credentials (auto-provided by Coolify)
      - POSTGRES_USER=$SERVICE_USER_POSTGRES
      - POSTGRES_PASSWORD=$SERVICE_PASSWORD_POSTGRES
      - POSTGRES_DB=n8n
      - TZ=Asia/Singapore
    
    restart: unless-stopped
    
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  #                           REDIS 7
  # ==========================================================================
  #
  # Message queue for distributing work between main instance and workers
  #
  # Configuration:
  #   - Password protected (requirepass)
  #   - AOF persistence (appendonly)
  #   - 1GB memory limit (optimized for 8GB VPS)
  #   - LRU eviction policy (least recently used)
  #
  # Memory Usage:
  #   - Typical: 200-500MB
  #   - Maximum: 1GB
  #   - After reaching limit: Evicts oldest items
  #
  # ==========================================================================
  
  redis:
    image: redis:7-alpine
    
    # ========================================================================
    # REDIS CONFIGURATION
    # ========================================================================
    command:
      - redis-server
      
      # PASSWORD PROTECTION
      # -------------------
      # ⚠️ CRITICAL: Change this password!
      # Generate secure password: openssl rand -base64 16
      - --requirepass
      - REPLACE_WITH_YOUR_REDIS_PASSWORD
      
      # PERSISTENCE
      # -----------
      # AOF (Append Only File): Logs every write operation
      # Survives Redis restarts without data loss
      - --appendonly
      - yes
      
      # MEMORY MANAGEMENT
      # -----------------
      # Limit Redis to 1GB RAM (prevents OOM on 8GB VPS)
      - --maxmemory
      - 1gb
      
      # EVICTION POLICY
      # ---------------
      # When memory limit reached: Remove least recently used keys
      # Alternative policies:
      #   - allkeys-lfu: Least frequently used
      #   - volatile-lru: LRU only on keys with TTL
      #   - noeviction: Return errors when full (not recommended)
      - --maxmemory-policy
      - allkeys-lru
      
    # ========================================================================
    # VOLUME MOUNTS
    # ========================================================================
    volumes:
      # Persistent Redis data (AOF files)
      - redis-data:/data
      
    environment:
      - TZ=Asia/Singapore
    
    restart: unless-stopped
    
    security_opt:
      - no-new-privileges:true

# ============================================================================
#                               VOLUMES
# ============================================================================
#
# Persistent storage that survives container recreation
#
# Volume Locations (on Coolify host):
#   - Managed by Coolify, typically in:
#     /var/lib/docker/volumes/[volume-name]/_data
#
# ============================================================================

volumes:
  # N8N data: workflows, credentials, settings, binary files
  n8n-data:
  
  # PostgreSQL data: database files
  postgresql-data:
  
  # Redis data: AOF persistence files
  redis-data:
